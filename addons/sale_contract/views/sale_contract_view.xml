<odoo>

    <record id="account_analytic_analysis.account_analytic_account_form_form" model="ir.ui.view">
        <field name="arch" type="xml">
            <xpath expr="/form/sheet" position='before'>
                <header  attrs="{'invisible': [('type','!=','template')]}">
                    <button name="set_close" string="Set to Inactive" type="object" states="open" />
                    <button name="set_open" string="Set to Active" type="object" states="close" />
                </header>
            </xpath>
            <xpath expr='//field[@name="partner_id"]' position='after'>
                <field name="pricelist_id"
                       class="oe_inline"
                       attrs="{'required': ['|',('invoice_on_timesheets', '=', True),('contract_type','=','subscription')], 'invisible': [('contract_type','=','prepaid')]}"
                       domain="[('type', '=', 'sale')]"
                       groups="product.group_sale_pricelist"/>
            </xpath>
            <xpath expr='//div[@name="duration"]' position='after'>
                <field name="close_reason_id" attrs="{'invisible': ['|',('type','!=','contract'),('state','in',['open','pending'])]}"/>
            </xpath>
            <notebook position="inside">
                <page id="prepaid" string="Prepaid Support Hours" attrs="{'invisible': ['|',('contract_type','!=','prepaid'),('type','in',['view','normal'])]}" >
                    <group>
                        <label for="quantity_max"/>
                        <div>
                            <field name="quantity_max"/>
                            <div attrs="{'invisible': [('hours_quantity','=',0)]}" class="oe_grey">
                                <field name="hours_quantity" class="oe_inline"/> Units Consumed
                            </div>
                            <div attrs="{'invisible': [('quantity_max','=',0)]}" class="oe_grey">
                                <field name="remaining_hours" class="oe_inline"/> Units Remaining
                            </div>
                        </div>
                    </group>
                    <group>
                        <p colspan="2" class="oe_grey oe_edit_only">
                            Once the end date of the contract is
                            passed or the maximum number of service
                            units (e.g. support contract) is
                            reached, the account manager is notified 
                            by email to renew the contract with the
                            customer.
                        </p>
                    </group>
                </page>
                <page id="billing_summary" string="Billing Summary" attrs="{'invisible': ['|',('contract_type','!=','regular'),('type','in',['view','normal'])]}">
                    <separator name="toinvoice" string="Invoicing"/>
                    <table class="oe_form_analytic_account">
                        <tr>
                            <th class="oe_timesheet_grey" width="160px"></th>
                            <th class="oe_timesheet_grey" width="25px"></th>
                            <th class="oe_timesheet_grey" width="100px"><label string="Expected"/></th>
                            <th class="oe_timesheet_grey" width="100px"><label string="Invoiced"/></th>
                            <th class="oe_timesheet_grey" width="100px"><label string="Remaining"/></th>
                            <th class="oe_timesheet_grey" width="100px"><label string="To Invoice"/></th>
                            <th width="30px"></th>
                            <th></th>
                        </tr><tr>
                            <td class="oe_timesheet_grey">
                                <label for="fix_price_invoices"/>
                            </td><td class="oe_timesheet_grey">
                                <field name="fix_price_invoices" class="oe_inline"/>
                            </td><td>
                                <field class="oe_inline" name="amount_max" attrs="{'invisible': [('fix_price_invoices','=',False)]}"/>
                            </td><td>
                                <field class="oe_inline" name="ca_invoiced" attrs="{'invisible': [('fix_price_invoices','=',False)]}"/>
                            </td><td>
                                <field class="oe_inline" name="remaining_ca" attrs="{'invisible': [('fix_price_invoices','=',False)]}"/>
                            </td><td>
                                <field class="oe_inline" name="fix_price_to_invoice" attrs="{'invisible': [('fix_price_invoices','=',False)]}"/>
                            </td><td attrs="{'invisible': [('fix_price_invoices','=',False)]}" class="oe_timesheet_action">
                                <span attrs="{'invisible': [('fix_price_to_invoice','=',0.0)]}" class="oe_grey">
                                    <button name="open_sale_order_lines"
                                        class="oe_link"
                                        string="⇒ Invoice" type="object"
                                        context="{'default_partner_id': [partner_id],'default_project_id': active_id,'search_default_uninvoiced': 1,'search_default_project_id': active_id,'search_default_partner_id': [partner_id]}"/>
                                    or view
                                </span>

                                <span attrs="{'invisible': [('fix_price_to_invoice','&lt;&gt;',0.0 )]}" class="oe_grey">
                                    No order to invoice, create
                                </span>
                                <button name="%(account_analytic_analysis.action_sales_order)d" string="Sales Orders"
                                    type="action"
                                    class="oe_link"
                                    context="{'default_partner_id': [partner_id], 'search_default_project_id': [active_id],'default_project_id': [active_id], 'default_pricelist_id': pricelist_id}"
                                    />
                            </td>
                        </tr><tr>
                            <td class="oe_timesheet_grey">
                                <label string="On Timesheets"/>
                            </td><td class="oe_timesheet_grey">
                            </td><td>
                                <field class="oe_inline" name="hours_qtt_est" attrs="{'invisible': [('invoice_on_timesheets','=',False)]}"/>
                            </td><td>
                                <field class="oe_inline" name="timesheet_ca_invoiced" attrs="{'invisible': [('invoice_on_timesheets','=',False)]}"/>
                            </td><td>
                                <field class="oe_inline" name="remaining_hours_to_invoice" attrs="{'invisible': [('invoice_on_timesheets','=',False)]}"/>
                            </td><td>
                                <field class="oe_inline" name="ca_to_invoice" attrs="{'invisible': [('invoice_on_timesheets','=',False)]}"/>
                            </td><td class="oe_timesheet_action" attrs="{'invisible': ['|',('invoice_on_timesheets','=',False),('type','=','template')]}">
                                <span attrs="{'invisible': [('ca_to_invoice','=',0.0)]}" class="oe_grey">
                                    <button name="hr_to_invoice_timesheets"
                                        type="object"
                                        class="oe_link"
                                        string="⇒ Invoice"/>
                                    or view 
                                </span>
                                <span attrs="{'invisible': [('ca_to_invoice','&lt;&gt;',0.0)]}" class="oe_grey">
                                    Nothing to invoice, create 
                                </span>

                                <button name="%(hr_timesheet.act_hr_timesheet_line_evry1_all_form)d"
                                    string="Timesheets" type="action"
                                    class="oe_link"
                                    context="{'default_account_id': active_id,'search_default_account_id': active_id}"/>
                            </td>
                        </tr><tr name='total'>
                            <th class="oe_timesheet_grey">
                                <label string="Total"/>
                            </th><td class="oe_timesheet_grey">
                            </td><td class="oe_timesheet_grey">
                                <field name="est_total" class="oe_inline" attrs="{'invisible': [('invoice_on_timesheets','=',False)]}"/>
                            </td><td class="oe_timesheet_grey">
                                <field name="invoiced_total" class="oe_inline"/>
                            </td><td class="oe_timesheet_grey">
                                <field name="remaining_total" class="oe_inline"/>
                            </td><td class="oe_timesheet_grey">
                                <field name="toinvoice_total" class="oe_inline"/>
                            </td><td>
                            </td>
                        </tr>
                    </table>
                    <group name='invoice_on_timesheets'>
                        <p name='invoice_on_timesheets_label' class="oe_grey oe_edit_only" colspan="2" attrs="{'invisible': [('invoice_on_timesheets','=',False)]}">
                            When reinvoicing costs, Odoo uses the
                            pricelist of the contract which uses the price
                            defined on the product related (e.g timesheet 
                            products are defined on each employee). 
                        </p>
                    </group>
                </page>
                <page id="recurring_lines" string="Subscription" attrs="{'invisible': ['|',('contract_type','!=','subscription'),('type','in',['view','normal'])]}">
                    <div>
                        <button string="=> Renewal Sale Order" class="oe_link oe_right" 
                                help="Create a sale order that will overwrite this contract when confirmed (renewal sale order)" 
                                name="prepare_renewal_order" type="object" attrs="{'invisible': [('type','!=','contract')]}" />
                        <field name="recurring_invoice_line_ids">
                            <tree string="Account Analytic Lines" editable="bottom">
                                <field name="product_id" on_change="product_id_change(product_id, uom_id, quantity, False, parent.partner_id, False, parent.pricelist_id, parent.company_id)"/>
                                <field name="name"/>
                                <field name="quantity"/>
                                <field name="actual_quantity"/>
                                <field name="uom_id" on_change="product_uom_change(product_id,uom_id,quantity,name,parent.partner_id, parent.pricelist_id,context)"/>
                                <field name="price_unit"/>
                                <field name="discount" groups="sale.group_discount_per_so_line"/>
                                <field name="price_subtotal"/>
                            </tree>
                        </field>
                        <group class="oe_subtotal_footer oe_right">
                            <field name="recurring_total" class="oe_subtotal_footer_separator"
                                widget="monetary" options="{'currency_field': 'pricelist_currency_id'}"
                                modifiers="{'readonly': true}"
                            />
                        </group>
                    </div>
                </page>
            </notebook>
           <field name="partner_id" position="attributes">
                <attribute name="attrs">{'invisible': [('type','in',['view','normal','template'])], 'required': [('type','=','contract'),'|',('fix_price_invoices','=',True), ('invoice_on_timesheets', '=', True)]}</attribute>
            </field>
            <xpath expr='//field[@name="manager_id"]' position='after'>
                <label for="recurring_interval" string="Contract Duration" attrs="{'invisible': [('type','!=','template')]}"/>
                <div attrs="{'invisible': [('type','!=','template')]}">
                    <field name="recurring_interval" class="oe_inline"/>
                    <field name="recurring_rule_type" class="oe_inline"/>
                </div>

                <label for="recurring_next_date" string="Date of Next Invoice" attrs="{'invisible': ['|',('type','=','template'),('contract_type','!=','subscription')]}"/>
                <div attrs="{'invisible': ['|',('type','=','template'),('contract_type','!=','subscription')]}">
                    <field name="recurring_next_date"  attrs="{'required': [('contract_type','=','subscription')]}"/>
                    <button string="=> Generate Invoice" class="oe_link" name="recurring_create_invoice"
                            type="object" attrs="{'invisible': [('type','!=','contract')]}" />
                </div>
            </xpath>
        </field>
    </record>

    <!-- Analytic Account list view for contract templates -->
    <record id="view_account_analytic_account_template_list" model="ir.ui.view">
        <field name="name">account.analytic.account.list</field>
        <field name="model">account.analytic.account</field>
        <field eval="10" name="priority"/>
        <field name="arch" type="xml">
            <tree toolbar="1" colors="grey:state=='close';" string="Analytic Accounts">
                <field name="complete_name"/>
                <field name="manager_id"/>
                <field name="contract_type"/>
                <field name="parent_id"/>
                <field name="state" invisible="1"/>
                <field name="company_id" groups="base.group_multi_company"/>
            </tree>
        </field>
    </record>

    <!-- From view for Close Reasons -->
    <record id="account_analytic_close_reason_view_tree" model="ir.ui.view">
        <field name="name">account.analytic.close.reason.list</field>
        <field name="model">account.analytic.close.reason</field>
        <field name="arch" type="xml">
            <tree string="Close Reasons" editable="bottom">
                <field name="sequence" widget="handle"/>
                <field name="name"/>
            </tree>
        </field>
    </record>

    <!-- Search view for contract templates -->
    <!-- Analytic Account search view for contract -->
    <record id="account_analytic_account_template_view_search" model="ir.ui.view">
        <field name="name">account.analytic.account.search</field>
        <field name="model">account.analytic.account</field>
        <field name="arch" type="xml">
            <search string="Contract Templates">
                <field name="name" filter_domain="['|', ('name','ilike',self),('code','ilike',self)]" string="Template"/>
                <filter name="open" string="Active" domain="[('state','in',('open','draft'))]" help="Contracts in progress (open, draft)"/>
                <filter name="closed" string="Inactive" domain="[('state','=','close')]" help="Closed contracts"/>
                <group expand="0" string="Group By">
                    <filter string="Parent" domain="[]" context="{'group_by':'parent_id'}"/>
                    <filter string="Company" domain="[]" context="{'group_by':'company_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action Sales/Configuration/Contract template -->
    <record id="template_of_regular_contract_action" model="ir.actions.act_window">
        <field name="name">Regular Contract Template</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">account.analytic.account</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="view_account_analytic_account_template_list"/>
        <field name="domain">[('type','=','template'),('contract_type','=','regular')]</field>
        <field name="context">{'search_default_type':'template','default_type' : 'template', 'default_contract_type': 'regular', 'search_default_open':1}</field>
        <field name="search_view_id" ref="account_analytic_account_template_view_search"/>
        <field name="help" type="html">
            <p class="oe_view_nocontent_create">
                Click here to create a template of contract.
            </p><p>
                Templates are used to prefigure contract/project that 
                can be selected by the salespeople to quickly configure the
                terms and conditions of the contract.
            </p>
        </field>
    </record>

    <record id="template_of_prepaid_contract_action" model="ir.actions.act_window">
        <field name="name">Prepaid Contract Template</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">account.analytic.account</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="view_account_analytic_account_template_list"/>
        <field name="domain">[('type','=','template'),('contract_type','=','prepaid')]</field>
        <field name="context">{'search_default_type':'template','default_type' : 'template', 'default_contract_type': 'prepaid', 'search_default_open':1}</field>
        <field name="search_view_id" ref="account_analytic_account_template_view_search"/>
        <field name="help" type="html">
            <p class="oe_view_nocontent_create">
                Click here to create a template of contract.
            </p><p>
                Templates are used to prefigure contract/project that 
                can be selected by the salespeople to quickly configure the
                terms and conditions of the contract.
            </p>
        </field>
    </record>

    <record id="template_of_subscription_contract_action" model="ir.actions.act_window">
        <field name="name">Subscription Contract Template</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">account.analytic.account</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="view_account_analytic_account_template_list"/>
        <field name="domain">[('type','=','template'),('contract_type','=','subscription')]</field>
        <field name="context">{'search_default_type':'template','default_type' : 'template', 'default_contract_type': 'subscription', 'search_default_open':1}</field>
        <field name="search_view_id" ref="account_analytic_account_template_view_search"/>
        <field name="help" type="html">
            <p class="oe_view_nocontent_create">
                Click here to create a template of contract.
            </p><p>
                Templates are used to prefigure contract/project that 
                can be selected by the salespeople to quickly configure the
                terms and conditions of the contract.
            </p>
        </field>
    </record>

    <record id="analytic_account_lost_reason_action" model="ir.actions.act_window">
        <field name="name">Close Reasons</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">account.analytic.close.reason</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree</field>
    </record>

    <!--<menuitem action="template_of_regular_contract_action" id="menu_template_of_regular_contract_action" parent="base.menu_sales_config" sequence="3"/> => this menu replaces the base template menu instead-->
    <menuitem action="template_of_prepaid_contract_action" id="menu_template_of_prepaid_contract_action" parent="base.menu_sales_config" sequence="4"/>
    <menuitem action="template_of_subscription_contract_action" id="menu_template_of_subscription_contract_action" parent="base.menu_sales_config" sequence="5"/>
    <menuitem action="analytic_account_lost_reason_action" id="menu_analytic_account_lost_reason_action" parent="base.menu_sales_config" sequence="10"/>
         
    <record id="account_analytic_analysis_form_form" model="ir.ui.view">
        <field name="name">account.analytic.account.invoice.form.inherit</field>
        <field name="model">account.analytic.account</field>
        <field name="inherit_id" ref="analytic.view_account_analytic_account_form"/>
        <field eval="20" name="priority"/>
        <field name="arch" type="xml">
            <xpath expr='//div[@name="buttons"]' position='after'>
                <div class="oe_right oe_button_box" name="buttons" attrs="{'invisible': [('type','!=','template')]}">
                    <button class="oe_inline oe_stat_button" string="Contracts"
                    icon="fa-book"
                    name="%(account_analytic_analysis.action_account_analytic_overdue_all)d"
                    context="{'search_default_template_id': [active_id], 'default_template_id': active_id}"
                    type="action"/>
                </div>
            </xpath>
        </field>
    </record>

    <!-- Inherited Analytic Account list for contracts -->
    <record id="view_account_analytic_account_tree_c2c_3" model="ir.ui.view">
        <field name="name">account.analytic.account.list.contract</field>
        <field name="model">account.analytic.account</field>
        <field name="inherit_id" ref="account_analytic_analysis.view_account_analytic_account_tree_c2c_3"/>
        <field name="groups_id" eval="[(4, ref('account.group_account_invoice'))]"/>
        <field name="arch" type="xml">
            <field name="date_start" position="before">
                <field name="contract_type"/>
            </field>
            <xpath expr="//field[@name='remaining_hours']" position='attributes'>
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//field[@name='toinvoice_total']" position='attributes'>
                <attribute name="invisible">1</attribute>
            </xpath>
        </field>
    </record>

    <!-- Overwriting some menus to set the correct views etc. -->
    <menuitem action="template_of_regular_contract_action" id="account_analytic_analysis.menu_template_of_contract_action" parent="base.menu_sales_config" sequence="3"/>

</odoo>